<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Expense Log">
    <title>Monthly Expense Log</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007AFF;
            --background: #F2F2F7;
            --card-background: #FFFFFF;
            --text-primary: #000000;
            --text-secondary: #8E8E93;
            --border-color: #C6C6C8;
            --danger-color: #FF3B30;
            --success-color: #34C759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        .header {
            background-color: var(--card-background);
            padding: 16px;
            margin: -16px -16px 16px -16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Home View Styles */
        .add-button {
            width: 100%;
            padding: 16px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
            -webkit-tap-highlight-color: transparent;
        }

        .add-button:active {
            transform: scale(0.98);
        }

        .month-list {
            list-style: none;
        }

        .month-item {
            background-color: var(--card-background);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
        }

        .month-item:active {
            transform: scale(0.98);
        }

        .month-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .month-name {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-total {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .month-remarks {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 48px 16px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Edit View Styles */
        .back-button {
            background-color: transparent;
            border: none;
            color: var(--primary-color);
            font-size: 17px;
            padding: 8px 0;
            margin-bottom: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
        }

        .back-button:active {
            opacity: 0.5;
        }

        .form-group {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .form-group-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-field {
            flex: 1;
        }

        label {
            display: block;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-background);
            color: var(--text-primary);
        }

        input[type="number"] {
            text-align: right;
            padding-right: 32px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--card-background);
            color: var(--text-primary);
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .total-display {
            background-color: var(--primary-color);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .total-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .total-amount {
            font-size: 36px;
            font-weight: 700;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--success-color);
            color: white;
            box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        /* Currency formatting */
        .currency::before {
            content: '‚Çπ';
            margin-right: 4px;
        }

        /* Budget display */
        .budget-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 4px;
            font-size: 12px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .budget-label {
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .budget-amount {
            font-weight: 600;
        }

        .budget-remaining {
            color: var(--success-color);
            white-space: nowrap;
        }

        .budget-exceeded {
            color: var(--danger-color);
            white-space: nowrap;
        }

        .budget-warning {
            color: #FF9500;
            white-space: nowrap;
        }

        .input-wrapper {
            position: relative;
        }

        .input-indicator {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        .indicator-ok {
            background-color: var(--success-color);
        }

        .indicator-warning {
            background-color: #FF9500;
        }

        .indicator-exceeded {
            background-color: var(--danger-color);
        }

        .budget-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .budget-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .budget-summary-row:last-child {
            margin-bottom: 0;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .budget-summary-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .budget-summary-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .settings-button {
            position: absolute;
            top: 16px;
            right: 16px;
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            -webkit-tap-highlight-color: transparent;
        }

        .settings-button:active {
            opacity: 0.5;
        }

        /* Chart View Styles */
        .chart-container {
            background-color: var(--card-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chart-canvas {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 24px;
            display: block;
        }

        .legend {
            list-style: none;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background-color: var(--background);
            border-radius: 8px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .legend-label {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .legend-value {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
            margin-left: 8px;
        }

        .legend-percentage {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
            color: var(--text-primary);
        }

        .view-chart-btn {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 8px;
            -webkit-tap-highlight-color: transparent;
        }

        .view-chart-btn:active {
            opacity: 0.7;
        }

        /* iOS-specific adjustments */
        @supports (-webkit-touch-callout: none) {
            body {
                padding-top: env(safe-area-inset-top);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 430px) {
            .container {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .month-total {
                font-size: 18px;
            }
            
            .total-amount {
                font-size: 32px;
            }
            
            .budget-info {
                font-size: 11px;
            }
            
            .budget-summary-amount {
                font-size: 16px;
            }
            
            label {
                font-size: 14px;
            }
            
            input[type="number"] {
                font-size: 16px;
                padding-right: 28px;
            }
            
            .input-indicator {
                right: 12px;
                width: 7px;
                height: 7px;
            }
        }
        
        @media (max-width: 375px) {
            .budget-summary {
                padding: 16px;
            }
            
            .budget-summary-label {
                font-size: 13px;
            }
            
            .budget-summary-amount {
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Home / Summary View -->
        <div id="homeView" class="view active">
            <div class="header">
                <h1>Monthly Expense Log</h1>
                <div class="subtitle">Track your monthly expenses</div>
                <button class="settings-button" onclick="showBudgetConfig()" title="Budget Settings">‚öôÔ∏è</button>
            </div>

            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                <button class="btn btn-secondary" onclick="exportData()" style="flex: 1; padding: 12px; font-size: 14px;">üì• Export Data</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="flex: 1; padding: 12px; font-size: 14px;">üì§ Import Data</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            </div>

            <button class="add-button" onclick="showEditView()">+ Add / Edit Month</button>

            <div id="monthListContainer">
                <ul id="monthList" class="month-list"></ul>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">üìä</div>
                    <p>No expense records yet</p>
                    <p style="margin-top: 8px; font-size: 14px;">Tap "Add / Edit Month" to get started</p>
                </div>
            </div>
        </div>

        <!-- Add / Edit Month View -->
        <div id="editView" class="view">
            <button class="back-button" onclick="showHomeView()">‚Üê Back to Summary</button>

            <div class="form-group">
                <div class="form-group-title">Period</div>
                <div class="form-row">
                    <div class="form-field">
                        <label for="month">Month</label>
                        <select id="month">
                            <option value="0">January</option>
                            <option value="1">February</option>
                            <option value="2">March</option>
                            <option value="3">April</option>
                            <option value="4">May</option>
                            <option value="5">June</option>
                            <option value="6">July</option>
                            <option value="7">August</option>
                            <option value="8">September</option>
                            <option value="9">October</option>
                            <option value="10">November</option>
                            <option value="11">December</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="year">Year</label>
                        <select id="year"></select>
                    </div>
                </div>
            </div>

            <div class="budget-summary" id="budgetSummary">
                <div class="budget-summary-row">
                    <span class="budget-summary-label">Total Budget</span>
                    <span class="budget-summary-amount currency" id="totalBudget">0.00</span>
                </div>
                <div class="budget-summary-row">
                    <span class="budget-summary-label">Total Spent</span>
                    <span class="budget-summary-amount currency" id="totalSpent">0.00</span>
                </div>
                <div class="budget-summary-row">
                    <span class="budget-summary-label" id="remainingLabel">Remaining</span>
                    <span class="budget-summary-amount currency" id="totalRemaining">0.00</span>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-title">Savings</div>
                <div class="form-field">
                    <label for="savingsEmi">Savings ‚Äì EMI</label>
                    <div class="input-wrapper">
                        <input type="number" id="savingsEmi" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-savingsEmi"></span>
                    </div>
                    <div class="budget-info" id="budget-savingsEmi"></div>
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="savingsRecurring">Savings ‚Äì Recurring</label>
                    <div class="input-wrapper">
                        <input type="number" id="savingsRecurring" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-savingsRecurring"></span>
                    </div>
                    <div class="budget-info" id="budget-savingsRecurring"></div>
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-title">Cards / Wallets</div>
                <div class="form-field">
                    <label for="savingsGpay">Savings GPay UPI</label>
                    <div class="input-wrapper">
                        <input type="number" id="savingsGpay" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-savingsGpay"></span>
                    </div>
                    <div class="budget-info" id="budget-savingsGpay"></div>
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="tataNeu">Tata Neu Infinity</label>
                    <div class="input-wrapper">
                        <input type="number" id="tataNeu" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-tataNeu"></span>
                    </div>
                    <div class="budget-info" id="budget-tataNeu"></div>
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="sbiOctane">SBI Octane</label>
                    <div class="input-wrapper">
                        <input type="number" id="sbiOctane" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-sbiOctane"></span>
                    </div>
                    <div class="budget-info" id="budget-sbiOctane"></div>
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="amazonPay">Amazon Pay</label>
                    <div class="input-wrapper">
                        <input type="number" id="amazonPay" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-amazonPay"></span>
                    </div>
                    <div class="budget-info" id="budget-amazonPay"></div>
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="hsbcLive">HSBC Live+</label>
                    <div class="input-wrapper">
                        <input type="number" id="hsbcLive" step="0.01" placeholder="0.00" oninput="calculateTotal()">
                        <span class="input-indicator" id="indicator-hsbcLive"></span>
                    </div>
                    <div class="budget-info" id="budget-hsbcLive"></div>
                </div>
            </div>

            <div class="total-display">
                <div class="total-label">Monthly Total</div>
                <div class="total-amount currency" id="totalAmount">0.00</div>
            </div>

            <div class="form-group">
                <div class="form-group-title">Remarks</div>
                <textarea id="remarks" placeholder="Note any unexpected expenses or one-time events..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                <button class="btn btn-primary" onclick="saveMonth()">Save</button>
            </div>
        </div>

        <!-- Budget Settings View -->
        <div id="budgetSettingsView" class="view">
            <button class="back-button" onclick="closeBudgetSettings()">‚Üê Back to Summary</button>

            <div class="header" style="margin: 0 0 24px 0; padding: 0; box-shadow: none;">
                <h1 style="font-size: 24px;">Budget Settings</h1>
                <div class="subtitle">Set your monthly budget for each category</div>
            </div>

            <div class="form-group">
                <div class="form-group-title">Savings</div>
                <div class="form-field">
                    <label for="budget-savingsEmi-input">Savings ‚Äì EMI</label>
                    <input type="number" id="budget-savingsEmi-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="budget-savingsRecurring-input">Savings ‚Äì Recurring</label>
                    <input type="number" id="budget-savingsRecurring-input" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <div class="form-group-title">Cards / Wallets</div>
                <div class="form-field">
                    <label for="budget-savingsGpay-input">Savings GPay UPI</label>
                    <input type="number" id="budget-savingsGpay-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="budget-tataNeu-input">Tata Neu Infinity</label>
                    <input type="number" id="budget-tataNeu-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="budget-sbiOctane-input">SBI Octane</label>
                    <input type="number" id="budget-sbiOctane-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="budget-amazonPay-input">Amazon Pay</label>
                    <input type="number" id="budget-amazonPay-input" step="0.01" placeholder="0.00">
                </div>
                <div class="form-field" style="margin-top: 12px;">
                    <label for="budget-hsbcLive-input">HSBC Live+</label>
                    <input type="number" id="budget-hsbcLive-input" step="0.01" placeholder="0.00">
                </div>
            </div>

            <div class="total-display" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="total-label">Total Monthly Budget</div>
                <div class="total-amount currency" id="totalBudgetDisplay">0.00</div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeBudgetSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBudgetSettings()">Save Budgets</button>
            </div>
        </div>

        <!-- Chart View -->
        <div id="chartView" class="view">
            <button class="back-button" onclick="closeChartView()">‚Üê Back to Summary</button>

            <div class="chart-container">
                <div class="chart-title" id="chartMonthTitle">Expense Breakdown</div>
                <canvas id="pieChart" class="chart-canvas" width="300" height="300"></canvas>
                <ul class="legend" id="chartLegend"></ul>
            </div>
        </div>
    </div>

    <script>
        // Constants
        const STORAGE_KEY = 'monthlyExpenses';
        const BUDGET_KEY = 'categoryBudgets';
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];

        // Budget Configuration (stored as JSON, modifiable)
        const DEFAULT_BUDGETS = {
            "savingsEmi": 147559.00,
            "savingsRecurring": 39146.00,
            "savingsGpay": 8000.00,
            "tataNeu": 6000.00,
            "sbiOctane": 21000.00,
            "amazonPay": 3000.00,
            "hsbcLive": 18500.00
        };

        // Get budgets from storage or use defaults
        function getBudgets() {
            const stored = localStorage.getItem(BUDGET_KEY);
            return stored ? JSON.parse(stored) : DEFAULT_BUDGETS;
        }

        // Save budgets to storage
        function saveBudgets(budgets) {
            localStorage.setItem(BUDGET_KEY, JSON.stringify(budgets));
        }

        // Show budget configuration
        function showBudgetConfig() {
            const budgets = getBudgets();
            
            // Load current budget values into form
            const categories = [
                'savingsEmi', 'savingsRecurring',
                'savingsGpay', 'tataNeu', 'sbiOctane', 
                'amazonPay', 'hsbcLive'
            ];
            
            categories.forEach(id => {
                const input = document.getElementById(`budget-${id}-input`);
                if (input) {
                    input.value = budgets[id] || '';
                }
            });
            
            // Calculate and display total budget
            updateTotalBudgetDisplay();
            
            // Listen for input changes to update total
            categories.forEach(id => {
                const input = document.getElementById(`budget-${id}-input`);
                if (input) {
                    input.addEventListener('input', updateTotalBudgetDisplay);
                }
            });
            
            // Show budget settings view
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('budgetSettingsView').classList.add('active');
        }
        
        // Update total budget display in settings view
        function updateTotalBudgetDisplay() {
            const categories = [
                'savingsEmi', 'savingsRecurring',
                'savingsGpay', 'tataNeu', 'sbiOctane', 
                'amazonPay', 'hsbcLive'
            ];
            
            let total = 0;
            categories.forEach(id => {
                const input = document.getElementById(`budget-${id}-input`);
                if (input) {
                    total += parseFloat(input.value) || 0;
                }
            });
            
            document.getElementById('totalBudgetDisplay').textContent = formatAmount(total);
        }
        
        // Save budget settings
        function saveBudgetSettings() {
            const categories = [
                'savingsEmi', 'savingsRecurring',
                'savingsGpay', 'tataNeu', 'sbiOctane', 
                'amazonPay', 'hsbcLive'
            ];
            
            const newBudgets = {};
            categories.forEach(id => {
                const input = document.getElementById(`budget-${id}-input`);
                if (input) {
                    newBudgets[id] = parseFloat(input.value) || 0;
                }
            });
            
            // Save to localStorage as JSON
            saveBudgets(newBudgets);
            
            // Update display if in edit view
            if (document.getElementById('editView').classList.contains('active')) {
                updateBudgetDisplay();
            }
            
            // Return to home view
            closeBudgetSettings();
        }
        
        // Close budget settings view
        function closeBudgetSettings() {
            document.getElementById('budgetSettingsView').classList.remove('active');
            document.getElementById('homeView').classList.add('active');
        }

        // Show chart view
        function showChartView(month, year) {
            const key = getMonthKey(month, year);
            const expenses = getAllExpenses();
            const data = expenses[key];
            
            if (!data) return;
            
            const monthName = MONTH_NAMES[month];
            document.getElementById('chartMonthTitle').textContent = `${monthName} ${year} - Expense Breakdown`;
            
            // Prepare chart data
            const categories = [
                { id: 'savingsEmi', label: 'Savings EMI', value: data.savingsEmi || 0 },
                { id: 'savingsRecurring', label: 'Savings Recurring', value: data.savingsRecurring || 0 },
                { id: 'savingsGpay', label: 'Savings GPay UPI', value: data.savingsGpay || 0 },
                { id: 'tataNeu', label: 'Tata Neu Infinity', value: data.tataNeu || 0 },
                { id: 'sbiOctane', label: 'SBI Octane', value: data.sbiOctane || 0 },
                { id: 'amazonPay', label: 'Amazon Pay', value: data.amazonPay || 0 },
                { id: 'hsbcLive', label: 'HSBC Live+', value: data.hsbcLive || 0 }
            ];
            
            // Filter out zero values
            const chartData = categories.filter(cat => cat.value > 0);
            
            if (chartData.length === 0) {
                alert('No expenses recorded for this month');
                return;
            }
            
            // Draw chart
            drawPieChart(chartData, data.total);
            
            // Show view
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('chartView').classList.add('active');
        }
        
        // Close chart view
        function closeChartView() {
            document.getElementById('chartView').classList.remove('active');
            document.getElementById('homeView').classList.add('active');
        }
        
        // Export data as JSON file
        function exportData() {
            const expenses = getAllExpenses();
            const budgets = getBudgets();
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                expenses: expenses,
                budgets: budgets
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `expense-log-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('Data exported successfully!');
        }
        
        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.expenses) {
                        throw new Error('Invalid file format: missing expenses data');
                    }
                    
                    // Confirm before overwriting
                    const confirm = window.confirm(
                        'This will replace all existing data. Are you sure you want to continue?\n\n' +
                        'Tip: Export your current data first as a backup.'
                    );
                    
                    if (!confirm) {
                        event.target.value = ''; // Reset file input
                        return;
                    }
                    
                    // Import expenses
                    saveAllExpenses(importedData.expenses);
                    
                    // Import budgets if available
                    if (importedData.budgets) {
                        saveBudgets(importedData.budgets);
                    }
                    
                    // Refresh the display
                    loadMonthList();
                    
                    alert('Data imported successfully!');
                    
                } catch (error) {
                    alert('Error importing data: ' + error.message + '\n\nPlease make sure the file is a valid expense log backup.');
                } finally {
                    event.target.value = ''; // Reset file input
                }
            };
            
            reader.readAsText(file);
        }
        
        // Draw pie chart
        function drawPieChart(data, total) {
            const canvas = document.getElementById('pieChart');
            const ctx = canvas.getContext('2d');
            const legend = document.getElementById('chartLegend');
            
            // Clear canvas and legend
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            legend.innerHTML = '';
            
            // Colors for categories
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
                '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
                '#F8B195', '#C06C84'
            ];
            
            // Calculate center and radius
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 10;
            
            let currentAngle = -Math.PI / 2; // Start at top
            
            data.forEach((item, index) => {
                const percentage = (item.value / total) * 100;
                const sliceAngle = (item.value / total) * 2 * Math.PI;
                
                // Draw slice
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Add white border between slices
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                currentAngle += sliceAngle;
                
                // Create legend item
                const legendItem = document.createElement('li');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-label">
                        <div class="legend-color" style="background-color: ${colors[index % colors.length]}"></div>
                        ${item.label}
                    </div>
                    <div>
                        <span class="legend-value currency">${formatAmount(item.value)}</span>
                        <span class="legend-percentage">(${percentage.toFixed(1)}%)</span>
                    </div>
                `;
                legend.appendChild(legendItem);
            });
        }

        // Initialize the app
        function init() {
            populateYearDropdown();
            setDefaultDate();
            loadMonthList();
        }

        // Populate year dropdown with range of years
        function populateYearDropdown() {
            const yearSelect = document.getElementById('year');
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 5;
            const endYear = currentYear + 2;

            for (let year = endYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        // Set default date to current month and year
        function setDefaultDate() {
            const now = new Date();
            document.getElementById('month').value = now.getMonth();
            document.getElementById('year').value = now.getFullYear();
        }

        // Get all expenses from local storage
        function getAllExpenses() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {};
        }

        // Save all expenses to local storage
        function saveAllExpenses(expenses) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
        }

        // Generate key for month/year combination
        function getMonthKey(month, year) {
            return `${year}-${String(month).padStart(2, '0')}`;
        }

        // Load and display month list
        function loadMonthList() {
            const expenses = getAllExpenses();
            const monthList = document.getElementById('monthList');
            const emptyState = document.getElementById('emptyState');
            
            monthList.innerHTML = '';

            // Convert to array and sort by date (newest first)
            const entries = Object.entries(expenses).sort((a, b) => b[0].localeCompare(a[0]));

            if (entries.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            entries.forEach(([key, data]) => {
                const [year, month] = key.split('-');
                const monthName = MONTH_NAMES[parseInt(month)];
                
                const li = document.createElement('li');
                li.className = 'month-item';
                li.onclick = () => editMonth(parseInt(month), parseInt(year));

                let html = `
                    <div class="month-item-header">
                        <div class="month-name">${monthName} ${year}</div>
                        <div class="month-total currency">${formatAmount(data.total)}</div>
                    </div>
                `;

                if (data.remarks) {
                    html += `<div class="month-remarks">${escapeHtml(data.remarks)}</div>`;
                }
                
                html += `<button class="view-chart-btn" onclick="event.stopPropagation(); showChartView(${parseInt(month)}, ${parseInt(year)});">üìä View Chart</button>`;

                li.innerHTML = html;
                monthList.appendChild(li);
            });
        }

        // Format amount with proper decimal places
        function formatAmount(amount) {
            return parseFloat(amount || 0).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Calculate and display total
        function calculateTotal() {
            const categories = [
                'savingsEmi', 'savingsRecurring',
                'savingsGpay', 'tataNeu', 'sbiOctane', 
                'amazonPay', 'hsbcLive'
            ];

            let total = 0;
            categories.forEach(id => {
                const value = parseFloat(document.getElementById(id).value) || 0;
                total += value;
            });

            document.getElementById('totalAmount').textContent = formatAmount(total);
            document.getElementById('totalSpent').textContent = formatAmount(total);
            
            updateBudgetDisplay();
        }

        // Update budget display for all categories
        function updateBudgetDisplay() {
            const budgets = getBudgets();
            const categories = [
                'savingsEmi', 'savingsRecurring',
                'savingsGpay', 'tataNeu', 'sbiOctane', 
                'amazonPay', 'hsbcLive'
            ];

            let totalBudget = 0;
            let totalSpent = 0;

            categories.forEach(id => {
                const budget = budgets[id] || 0;
                const spent = parseFloat(document.getElementById(id).value) || 0;
                const remaining = budget - spent;
                const percentUsed = budget > 0 ? (spent / budget) * 100 : 0;

                totalBudget += budget;
                totalSpent += spent;

                // Update budget info display
                const budgetInfo = document.getElementById(`budget-${id}`);
                const indicator = document.getElementById(`indicator-${id}`);
                
                if (budget > 0) {
                    let statusClass = 'budget-remaining';
                    let indicatorClass = 'indicator-ok';
                    let statusText = `Remaining: ‚Çπ${formatAmount(Math.abs(remaining))}`;
                    
                    if (spent > budget) {
                        statusClass = 'budget-exceeded';
                        indicatorClass = 'indicator-exceeded';
                        statusText = `Over: ‚Çπ${formatAmount(Math.abs(remaining))}`;
                    } else if (percentUsed > 90) {
                        statusClass = 'budget-warning';
                        indicatorClass = 'indicator-warning';
                    }

                    budgetInfo.innerHTML = `
                        <span class="budget-label">Budget: ‚Çπ${formatAmount(budget)}</span>
                        <span class="${statusClass}">${statusText}</span>
                    `;

                    if (spent > 0) {
                        indicator.className = `input-indicator ${indicatorClass}`;
                        indicator.style.display = 'block';
                    } else {
                        indicator.style.display = 'none';
                    }
                } else {
                    budgetInfo.innerHTML = '<span class="budget-label">No budget set</span>';
                    indicator.style.display = 'none';
                }
            });

            // Update budget summary
            document.getElementById('totalBudget').textContent = formatAmount(totalBudget);
            document.getElementById('totalSpent').textContent = formatAmount(totalSpent);
            
            const totalRemaining = totalBudget - totalSpent;
            document.getElementById('totalRemaining').textContent = formatAmount(Math.abs(totalRemaining));
            
            const remainingLabel = document.getElementById('remainingLabel');
            const remainingAmount = document.getElementById('totalRemaining');
            
            if (totalRemaining < 0) {
                remainingLabel.textContent = 'Over Budget';
                remainingAmount.style.color = '#ff6b6b';
            } else {
                remainingLabel.textContent = 'Remaining';
                remainingAmount.style.color = '#51cf66';
            }
        }

        // Show edit view with new entry
        function showEditView() {
            setDefaultDate();
            clearForm();
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('editView').classList.add('active');
            
            // Try to load existing data for current month
            loadMonthData();
        }

        // Show home view
        function showHomeView() {
            document.getElementById('editView').classList.remove('active');
            document.getElementById('budgetSettingsView').classList.remove('active');
            document.getElementById('chartView').classList.remove('active');
            document.getElementById('homeView').classList.add('active');
            loadMonthList();
        }

        // Edit existing month
        function editMonth(month, year) {
            document.getElementById('month').value = month;
            document.getElementById('year').value = year;
            loadMonthData();
            document.getElementById('homeView').classList.remove('active');
            document.getElementById('editView').classList.add('active');
        }

        // Load data for selected month/year
        function loadMonthData() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const key = getMonthKey(month, year);
            
            const expenses = getAllExpenses();
            const data = expenses[key];

            if (data) {
                document.getElementById('savingsEmi').value = data.savingsEmi || '';
                document.getElementById('savingsRecurring').value = data.savingsRecurring || '';
                document.getElementById('savingsGpay').value = data.savingsGpay || '';
                document.getElementById('tataNeu').value = data.tataNeu || '';
                document.getElementById('sbiOctane').value = (data.sbiOctane || 0) + (data.octaneGpay || 0) || '';
                document.getElementById('amazonPay').value = data.amazonPay || '';
                document.getElementById('hsbcLive').value = data.hsbcLive || '';
                document.getElementById('remarks').value = data.remarks || '';
            } else {
                clearForm();
            }

            calculateTotal();
            updateBudgetDisplay();
        }

        // Clear form
        function clearForm() {
            const inputs = document.querySelectorAll('#editView input[type="number"], #editView textarea');
            inputs.forEach(input => input.value = '');
            
            // Set default values for constant expenses from budget
            const budgets = getBudgets();
            if (budgets.savingsEmi) {
                document.getElementById('savingsEmi').value = budgets.savingsEmi;
            }
            if (budgets.savingsRecurring) {
                document.getElementById('savingsRecurring').value = budgets.savingsRecurring;
            }
            
            calculateTotal();
            updateBudgetDisplay();
        }

        // Cancel edit
        function cancelEdit() {
            showHomeView();
        }

        // Save month data
        function saveMonth() {
            const month = document.getElementById('month').value;
            const year = document.getElementById('year').value;
            const key = getMonthKey(month, year);

            const data = {
                savingsEmi: parseFloat(document.getElementById('savingsEmi').value) || 0,
                savingsRecurring: parseFloat(document.getElementById('savingsRecurring').value) || 0,
                savingsGpay: parseFloat(document.getElementById('savingsGpay').value) || 0,
                tataNeu: parseFloat(document.getElementById('tataNeu').value) || 0,
                sbiOctane: parseFloat(document.getElementById('sbiOctane').value) || 0,
                amazonPay: parseFloat(document.getElementById('amazonPay').value) || 0,
                hsbcLive: parseFloat(document.getElementById('hsbcLive').value) || 0,
                remarks: document.getElementById('remarks').value.trim(),
                total: 0
            };

            // Calculate total
            data.total = data.savingsEmi + data.savingsRecurring +
                        data.savingsGpay + data.tataNeu + data.sbiOctane +
                        data.amazonPay + data.hsbcLive;

            // Save to storage
            const expenses = getAllExpenses();
            expenses[key] = data;
            saveAllExpenses(expenses);

            // Return to home view
            showHomeView();
        }

        // Listen for month/year changes to load existing data
        document.getElementById('month').addEventListener('change', loadMonthData);
        document.getElementById('year').addEventListener('change', loadMonthData);

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>